# راه‌اندازی درگاه پرداخت زرین‌پال

این پروژه به صورت داخلی از سرویس پرداخت زرین‌پال پشتیبانی می‌کند. برای فعال‌سازی کامل و حرفه‌ای درگاه کافی است مراحل زیر را انجام دهید.

## 1. تنظیم متغیرهای محیطی

فایل `.env` موجود در پوشه `server/` را باز کرده و مقادیر زیر را تنظیم کنید. مقادیر نمونه در `.env.example` هم موجود است.

```env
PAYMENT_RETURN_URL=http://localhost:5500/IQuiz-bot.html
ZARINPAL_MERCHANT_ID=d97f7648-614f-4025-bee2-5f3cda6d8fcd
ZARINPAL_SANDBOX=false
ZARINPAL_CALLBACK_BASE_URL=http://localhost:4000
```

توضیح متغیرها:

- **PAYMENT_RETURN_URL**: آدرس صفحه‌ای که پس از پایان پرداخت کاربر باید به آن بازگردد. در نسخه لوکال می‌توانید از همان صفحه اصلی ربات استفاده کنید.
- **ZARINPAL_MERCHANT_ID**: مرچنت‌کد دریافتی از زرین‌پال. در این پروژه مقدار بالا ثبت شده است.
- **ZARINPAL_SANDBOX**: اگر می‌خواهید پرداخت‌ها را در محیط سندباکس تست کنید مقدار را روی `true` بگذارید. برای محیط اصلی مقدار `false` مناسب است.
- **ZARINPAL_CALLBACK_BASE_URL**: دامنه‌ای که سرور شما روی آن در دسترس است. زرین‌پال پس از پرداخت کاربر را به مسیر `/payments/zarinpal/callback` در همین دامنه هدایت می‌کند.

پس از ذخیره تغییرات، سرویس Node.js را ری‌استارت کنید تا تنظیمات جدید اعمال شود.

## 2. نحوه کار جریان پرداخت

1. کاربر بسته مورد نظر را انتخاب کرده و درخواست `/api/payments/zarinpal/create` ارسال می‌شود.
2. سرور با استفاده از مرچنت‌کد تنظیم‌شده، درخواست `request.json` زرین‌پال را فراخوانی می‌کند.
3. در صورت موفقیت، آدرس پرداخت (StartPay) به کلاینت بازگردانده می‌شود و کاربر به درگاه منتقل می‌گردد.
4. زرین‌پال پس از پرداخت کاربر را به مسیر `ZARINPAL_CALLBACK_BASE_URL/payments/zarinpal/callback` هدایت می‌کند.
5. سرور با فراخوانی `verify.json` وضعیت تراکنش را بررسی کرده و نتیجه را از طریق پارامترهای `payment_status`، `payment_id` و در صورت موفقیت `ref_id` به صفحه بازگشت ارسال می‌کند.

## 3. بررسی وضعیت تراکنش در رابط کاربری

پس از بازگشت کاربر به برنامه، تابع `handleGatewayReturn` در فایل فرانت‌اند `Iquiz-assets/src/app/bootstrap.js` وضعیت پرداخت را از مسیر `/api/payments/:id/status` استعلام می‌گیرد و در صورت موفقیت کیف‌پول کاربر به‌روزرسانی می‌شود.

> نکته: برای جلوگیری از هرگونه دستکاری، توکن یک‌بارمصرفی به‌نام `callbackToken` ایجاد و در تمام بازگشت‌ها کنترل می‌شود.

با انجام مراحل بالا، درگاه زرین‌پال برای پروژه به صورت کامل و استاندارد پیکربندی خواهد شد.
